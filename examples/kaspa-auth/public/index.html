<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Auth - Web Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #70c7ba 0%, #5db3a8 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1em;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #48bb78;
        }
        
        .connection-status {
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .connected {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .disconnected {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .auth-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .auth-button {
            background: linear-gradient(135deg, #70c7ba 0%, #5db3a8 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
            display: block;
            margin: 0 auto;
        }
        
        .auth-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(112, 199, 186, 0.3);
        }
        
        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .progress-indicator {
            display: none;
            margin-top: 30px;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .progress-step.pending {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .progress-step.active {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .progress-step.complete {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #22c55e;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 0.9em;
        }
        
        .pending .step-number {
            background: #e2e8f0;
            color: #64748b;
        }
        
        .active .step-number {
            background: #3b82f6;
            color: white;
        }
        
        .complete .step-number {
            background: #22c55e;
            color: white;
        }
        
        .success-card {
            display: none;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-top: 30px;
        }
        
        .success-card h3 {
            margin-top: 0;
            font-size: 1.5em;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .info-card h3 {
            margin-top: 0;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .endpoint-list {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .endpoint-item {
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .method {
            font-weight: bold;
            color: #e53e3e;
            margin-right: 10px;
        }
        
        .method.get {
            color: #38a169;
        }
        
        .method.post {
            color: #3182ce;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Kaspa Auth Dashboard</h1>
            <p>Secure blockchain-based authentication with real-time updates</p>
        </div>
        
        <div class="status-bar">
            <div>
                <strong>üåê WebSocket Status:</strong>
                <span id="wsStatus" class="connection-status disconnected">‚ùå Connecting...</span>
            </div>
            <div>
                <strong>‚ö° Server:</strong> localhost:8080
            </div>
        </div>
        
        <div id="fundingInfo" class="info-card" style="margin-bottom: 30px; display: none;">
            <h3>üí∞ Address Information</h3>
            <div style="font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.8;">
                <div><strong>üñ•Ô∏è Server Address (Coordination):</strong> <span id="serverAddress">Loading...</span></div>
                <div style="font-size: 0.8em; color: #666; margin-left: 20px;">Only shows funding transactions (1000 TKAS)</div>
                <div style="margin-top: 10px;"><strong>üì± Client Address (Authentication):</strong> <span id="clientAuthAddress">Generated per session</span></div>
                <div style="font-size: 0.8em; color: #666; margin-left: 20px;">Check console for real authentication address</div>
                <div style="margin-top: 10px;"><strong>üåê Network:</strong> <span id="networkInfo">testnet-10</span></div>
                <div><strong>üè∑Ô∏è Transaction Prefix:</strong> <span id="txPrefix">0x41555448 (AUTH)</span></div>
                <div style="margin-top: 15px;">
                    <strong>üîç Explorer Links:</strong><br>
                    <a href="#" id="explorerLink" target="_blank" style="color: #70c7ba; text-decoration: none;">
                        üîó View Server Address (Coordination)
                    </a><br>
                    <a href="https://faucet.kaspanet.io/" target="_blank" style="color: #70c7ba; text-decoration: none;">
                        üö∞ Get Testnet Funds
                    </a>
                </div>
            </div>
        </div>
        
        <div class="auth-section">
            <h2>üöÄ Quick Authentication Test</h2>
            <p>Test the complete authentication flow with auto-generated keypair</p>
            <div style="background: #dcfce7; border: 1px solid #86efac; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 0.9em;">
                <strong>üîê Real Blockchain Authentication:</strong> This Web UI generates real secp256k1 keypairs, 
                signs challenges with actual cryptography, and submits verification to Kaspa blockchain.
                <br><strong>‚ö° Live Experience:</strong> Watch real-time blockchain confirmation via WebSocket!
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 0.9em;">
                <strong>üîç Address Investigation:</strong> The server address above only shows coordination (1000 TKAS funding). 
                For AUTH transactions, check the <strong>client address</strong> shown in browser console after clicking authenticate!
                <br><strong>üìä Authentication reuses the SAME client address</strong> - persistent episodes until reset.
            </div>
            <button id="authButton" class="auth-button" onclick="startAuthentication()">
                üîë Start Authentication Flow
            </button>
            <button class="auth-button" onclick="resetEpisodes()" style="background-color: #dc3545; margin-left: 10px;">
                üóëÔ∏è Reset Episodes (Create New)
            </button>
            
            <div id="progressIndicator" class="progress-indicator">
                <div id="step1" class="progress-step pending">
                    <div class="step-number">1</div>
                    <div>Generate cryptographic keypair</div>
                </div>
                <div id="step2" class="progress-step pending">
                    <div class="step-number">2</div>
                    <div>Create authentication episode</div>
                </div>
                <div id="step3" class="progress-step pending">
                    <div class="step-number">3</div>
                    <div>Request challenge from blockchain</div>
                </div>
                <div id="step4" class="progress-step pending">
                    <div class="step-number">4</div>
                    <div>Receive challenge (real-time via WebSocket)</div>
                </div>
                <div id="step5" class="progress-step pending">
                    <div class="step-number">5</div>
                    <div>Sign challenge locally</div>
                </div>
                <div id="step6" class="progress-step pending">
                    <div class="step-number">6</div>
                    <div>Submit verification & receive session token</div>
                </div>
            </div>
        </div>
        
        <div class="success-card" id="successCard">
            <h3>üéâ Authentication Successful!</h3>
            <p id="sessionInfo">Session token: <strong id="sessionToken"></strong></p>
            <p id="episodeInfo">Episode ID: <strong id="episodeId"></strong></p>
            <p id="clientAddressInfo">Client Address: <strong id="clientKaspaAddress"></strong></p>
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                <p><strong>üîç Find Your Authentication:</strong></p>
                <p style="font-size: 0.9em;">
                    Search for episode ID <span id="searchEpisodeId"></span> on 
                    <a href="#" id="successExplorerLink" target="_blank" style="color: white; text-decoration: underline;">
                        Kaspa Explorer
                    </a>
                </p>
                <p style="font-size: 0.8em; opacity: 0.8;">
                    Look for transactions with AUTH prefix (0x41555448) containing your episode ID
                </p>
            </div>
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <h3>üì° Available Endpoints</h3>
                <div class="endpoint-list">
                    <div class="endpoint-item">
                        <span class="method get">GET</span> / - Server info
                    </div>
                    <div class="endpoint-item">
                        <span class="method get">GET</span> /health - Health check
                    </div>
                    <div class="endpoint-item">
                        <span class="method get">GET</span> /funding-info - Economic parameters
                    </div>
                    <div class="endpoint-item">
                        <span class="method post">POST</span> /auth/start - Create episode
                    </div>
                    <div class="endpoint-item">
                        <span class="method post">POST</span> /auth/request-challenge - Request challenge
                    </div>
                    <div class="endpoint-item">
                        <span class="method post">POST</span> /auth/verify - Submit verification
                    </div>
                    <div class="endpoint-item">
                        <span class="method get">GET</span> /auth/status/{id} - Episode status
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>üîå WebSocket Events</h3>
                <div class="endpoint-list">
                    <div class="endpoint-item">challenge_issued</div>
                    <div class="endpoint-item">authentication_successful</div>
                    <div class="endpoint-item">authentication_failed</div>
                    <div class="endpoint-item">episode_updated</div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>üõ†Ô∏è Development Tools</h3>
                <div class="endpoint-list">
                    <div class="endpoint-item">
                        <strong>CLI Test:</strong><br>
                        <code>cargo run -- test-api-flow</code>
                    </div>
                    <div class="endpoint-item">
                        <strong>Manual Auth:</strong><br>
                        <code>cargo run -- authenticate</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { secp256k1 } from "https://cdn.skypack.dev/@noble/curves@1.4.0/secp256k1";
        import { sha256 } from "https://cdn.skypack.dev/@noble/hashes@1.4.0/sha256";

        let websocket = null;
        let currentEpisodeId = null;
        let privateKey = null;
        let publicKeyHex = null;

        // Utility function to convert bytes to hex string (since bytesToHex from noble-hashes is problematic via CDN)
        function bytesToHex(bytes) {
            return Array.from(bytes, (byte) => byte.toString(16).padStart(2, '0')).join('');
        }
        
        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                document.getElementById('wsStatus').textContent = '‚úÖ Connected';
                document.getElementById('wsStatus').className = 'connection-status connected';
            };
            
            websocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            websocket.onclose = function() {
                document.getElementById('wsStatus').textContent = '‚ùå Disconnected';
                document.getElementById('wsStatus').className = 'connection-status disconnected';
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        }
        
        function handleWebSocketMessage(message) {
            console.log('WebSocket message:', message);
            
            switch(message.type) {
                case 'challenge_issued':
                    // JavaScript-safe episode IDs can be compared directly
                    if (message.episode_id === currentEpisodeId) {
                        updateStep(4, 'complete');
                        updateStep(5, 'active');
                    }
                    break;
                    
                case 'authentication_successful':
                    // JavaScript-safe episode IDs can be compared directly
                    if (message.episode_id === currentEpisodeId) {
                        updateStep(6, 'complete');
                        showSuccess(message.session_token, message.episode_id);
                    }
                    break;
                    
                case 'authentication_failed':
                    alert('Authentication failed: ' + message.reason);
                    resetUI();
                    break;
            }
        }
        
        window.startAuthentication = async function() {
            const button = document.getElementById('authButton');
            const progress = document.getElementById('progressIndicator');
            
            button.disabled = true;
            button.textContent = 'üîÑ Authenticating...';
            progress.style.display = 'block';
            
            try {
                // Step 1: Get/Create persistent client wallet (like CLI)
                updateStep(1, 'active');
                
                const walletResponse = await fetch('/wallet/client');
                if (!walletResponse.ok) {
                    throw new Error(`Failed to get client wallet: ${walletResponse.status}`);
                }
                
                const walletData = await walletResponse.json();
                publicKeyHex = walletData.public_key;
                let clientKaspaAddress = walletData.kaspa_address;
                
                console.log('üîç DEBUG: Using persistent client wallet');
                console.log('üîç DEBUG: Public key:', publicKeyHex);
                console.log('üîç DEBUG: Client address:', clientKaspaAddress);
                console.log('üîç DEBUG: Was created:', walletData.was_created);
                console.log('üîç DEBUG: Needs funding:', walletData.needs_funding);
                
                if (walletData.needs_funding) {
                    console.log('‚ö†Ô∏è WARNING: Client wallet needs funding!');
                    console.log('üö∞ Get testnet funds: https://faucet.kaspanet.io/');
                    console.log('üí∞ Send to address:', clientKaspaAddress);
                }
                
                updateStep(1, 'complete');
                
                // Step 2: Create episode
                updateStep(2, 'active');
                const startResponse = await fetch('/auth/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ public_key: publicKeyHex })
                });
                
                if (!startResponse.ok) {
                    throw new Error(`Failed to start auth: ${startResponse.status}`);
                }
                
                const startData = await startResponse.json();
                currentEpisodeId = startData.episode_id;
                clientKaspaAddress = startData.client_kaspa_address;
                
                console.log('üîç DEBUG: Episode created:', currentEpisodeId);
                console.log('üîç DEBUG: Client Kaspa address:', clientKaspaAddress);
                console.log('üîç DEBUG: This is the address to check on explorer for AUTH transactions!');
                
                updateStep(2, 'complete');
                
                // Step 3: Request challenge
                updateStep(3, 'active');
                const challengeResponse = await fetch('/auth/request-challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        episode_id: currentEpisodeId,
                        public_key: publicKeyHex
                    })
                });
                
                if (!challengeResponse.ok) {
                    throw new Error(`Failed to request challenge: ${challengeResponse.status}`);
                }
                
                updateStep(3, 'complete');
                
                // Step 4: Wait for challenge (WebSocket will handle this)
                updateStep(4, 'active');
                
                // Poll for challenge if WebSocket doesn't deliver
                let challenge = null;
                for (let i = 0; i < 10; i++) {
                    await sleep(1000);
                    const statusResponse = await fetch(`/auth/status/${currentEpisodeId}`);
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        if (statusData.challenge) {
                            challenge = statusData.challenge;
                            updateStep(4, 'complete');
                            break;
                        }
                    }
                }
                
                if (!challenge) {
                    throw new Error('Timeout waiting for challenge');
                }
                
                // Step 5: Sign challenge
                updateStep(5, 'active');
                const signature = await signChallenge(challenge);
                updateStep(5, 'complete');
                
                // Step 6: Submit verification
                updateStep(6, 'active');
                const verifyResponse = await fetch('/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        episode_id: currentEpisodeId,
                        signature: signature,
                        nonce: challenge
                    })
                });
                
                if (!verifyResponse.ok) {
                    throw new Error(`Failed to verify: ${verifyResponse.status}`);
                }
                
                const verifyData = await verifyResponse.json();
                updateStep(6, 'complete');
                
                // Get final status
                const finalStatusResponse = await fetch(`/auth/status/${currentEpisodeId}`);
                if (finalStatusResponse.ok) {
                    const finalStatus = await finalStatusResponse.json();
                    if (finalStatus.session_token) {
                        showSuccess(finalStatus.session_token, currentEpisodeId, clientKaspaAddress);
                    }
                }
                
            } catch (error) {
                console.error('Authentication error:', error);
                alert(`Authentication failed: ${error.message}`);
                resetUI();
            }
        }
        
        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `progress-step ${status}`;
        }
        
        function showSuccess(sessionToken, episodeId, clientKaspaAddress) {
            document.getElementById('sessionToken').textContent = sessionToken;
            document.getElementById('episodeId').textContent = episodeId;
            document.getElementById('searchEpisodeId').textContent = episodeId;
            document.getElementById('clientKaspaAddress').textContent = clientKaspaAddress;
            
            // Get server address for explorer link
            const explorerUrl = `https://explorer-tn10.kaspa.org/addresses/${clientKaspaAddress}`;
            document.getElementById('successExplorerLink').href = explorerUrl;
            
            document.getElementById('successCard').style.display = 'block';
        }
        
        function resetUI() {
            const button = document.getElementById('authButton');
            const progress = document.getElementById('progressIndicator');
            const success = document.getElementById('successCard');
            
            button.disabled = false;
            button.textContent = 'üîë Start Authentication Flow';
            progress.style.display = 'none';
            success.style.display = 'none';
            
            // Reset all steps
            for (let i = 1; i <= 6; i++) {
                updateStep(i, 'pending');
            }
            
            currentEpisodeId = null;
            privateKey = null;
            publicKeyHex = null;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function signChallenge(challenge) {
            // Use server-side signing with persistent client wallet
            const response = await fetch('/auth/sign-challenge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    challenge: challenge,
                    private_key: "use_client_wallet" // Signal to use persistent client wallet
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to sign challenge: ${response.status}`);
            }
            
            const signData = await response.json();
            return signData.signature;
        }
        
        // Load funding information
        async function loadFundingInfo() {
            try {
                // Load server info
                const response = await fetch('/funding-info');
                if (response.ok) {
                    const data = await response.json();
                    
                    const serverAddressEl = document.getElementById('serverAddress');
                    const networkInfoEl = document.getElementById('networkInfo');
                    const txPrefixEl = document.getElementById('txPrefix');
                    
                    if (serverAddressEl) serverAddressEl.textContent = data.funding_address;
                    if (networkInfoEl) networkInfoEl.textContent = data.network;
                    if (txPrefixEl) txPrefixEl.textContent = data.transaction_prefix + ' (' + data.transaction_prefix_meaning + ')';
                    
                    // Set explorer link to correct testnet explorer
                    const explorerUrl = `https://explorer-tn10.kaspa.org/addresses/${data.funding_address}`;
                    const explorerLinkEl = document.getElementById('explorerLink');
                    if (explorerLinkEl) explorerLinkEl.href = explorerUrl;
                }
                
                // Load client wallet status
                const walletResponse = await fetch('/wallet/status');
                if (walletResponse.ok) {
                    const walletData = await walletResponse.json();
                    
                    if (walletData.exists) {
                        document.getElementById('clientAuthAddress').textContent = walletData.kaspa_address;
                        
                        if (walletData.needs_funding) {
                            document.getElementById('clientAuthAddress').style.color = '#e53e3e';
                            document.getElementById('clientAuthAddress').textContent += ' (NEEDS FUNDING)';
                        } else {
                            document.getElementById('clientAuthAddress').style.color = '#22c55e';
                        }
                    } else {
                        document.getElementById('clientAuthAddress').textContent = 'Will be created on first authentication';
                    }
                }
                
                // Show the funding info section
                document.getElementById('fundingInfo').style.display = 'block';
            } catch (error) {
                console.error('Error loading funding info:', error);
            }
        }
        
        // Reset episodes function
        async function resetEpisodes() {
            if (!confirm('Are you sure you want to reset all episodes? This will force creation of new episodes on next authentication.')) {
                return;
            }
            
            try {
                const response = await fetch('/auth/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ ${data.message}\nEpisodes cleared: ${data.episodes_cleared}`);
                    
                    // Reset UI state
                    document.getElementById('successCard').style.display = 'none';
                    document.getElementById('progressIndicator').style.display = 'none';
                    document.getElementById('authButton').textContent = 'üîë Start Authentication Flow';
                    
                    // Reset all progress steps
                    for (let i = 1; i <= 6; i++) {
                        const step = document.getElementById(`step${i}`);
                        step.className = 'progress-step pending';
                    }
                } else {
                    alert('‚ùå Failed to reset episodes');
                }
            } catch (error) {
                console.error('Reset error:', error);
                alert('‚ùå Error resetting episodes');
            }
        }
        
        // Initialize WebSocket connection and load funding info when page loads
        window.addEventListener('load', function() {
            connectWebSocket();
            loadFundingInfo();
        });

        window.startAuthentication = startAuthentication;
    </script>
</body>
</html>