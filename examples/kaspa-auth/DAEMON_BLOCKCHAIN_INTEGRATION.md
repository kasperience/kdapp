# Daemon Blockchain Integration

This document outlines the changes made to integrate the `kdapp` engine and Kaspa blockchain functionality into the `kaspa-auth` daemon.

## Overview

The daemon was previously a skeleton with mock implementations for blockchain interactions. This integration transforms it into a fully-functional, peer-to-peer authentication service that interacts directly with the Kaspa testnet.

## Key Changes in `src/daemon/service.rs`

### 1. `AuthDaemon` Struct Enhancements

The `AuthDaemon` struct has been extended to include fields necessary for `kdapp` engine and Kaspa node interaction:

-   `kaspad_client`: An `Arc<Option<KaspaRpcClient>>` to manage the connection to the Kaspa node.
-   `kdapp_engine_tx`: An `mpsc::Sender<EngineCommand<SimpleAuth>>` to send commands to the `kdapp` engine.
-   `blockchain_episodes`: A `SharedEpisodeState` (Arc<Mutex<HashMap<u64, SimpleAuth>>>) to store and access the real blockchain-derived episode states.
-   `daemon_keypair`: The daemon's own `Keypair` for generating transactions if needed.
-   `transaction_generator`: An `Arc<TransactionGenerator>` for building Kaspa transactions.
-   `exit_signal`: An `Arc<AtomicBool>` for graceful shutdown of the `kdapp` listener.

### 2. `DaemonAuthHandler` Implementation

A new struct, `DaemonAuthHandler`, has been introduced. This struct implements the `EpisodeEventHandler<SimpleAuth>` trait, allowing it to receive and process updates from the `kdapp` engine.

-   `on_initialize`: Stores newly initialized episodes from the blockchain into `blockchain_episodes`.
-   `on_command`: Updates episode states in `blockchain_episodes` and, crucially, creates `Session` entries in the daemon's `sessions` HashMap when an authentication is successful on the blockchain.
-   `on_rollback`: Removes rolled-back episodes from `blockchain_episodes`.

### 3. `AuthDaemon::new` Refactoring

The constructor for `AuthDaemon` now initializes the `kdapp` engine and its associated components:

-   Connects to the Kaspa testnet using `connect_client`.
-   Initializes `TransactionGenerator` with the daemon's own keypair.
-   Spawns a background Tokio task that:
    -   Creates a `DaemonAuthHandler`.
    -   Starts the `kdapp::engine::Engine` with the `DaemonAuthHandler`.
    -   Runs the `kdapp::proxy::run_listener` to listen for blockchain events, making the daemon a real `kdapp` node.

### 4. `AuthDaemon::run` Modifications

The `run` method now includes logic for graceful shutdown of the `kdapp` listener using the `exit_signal`.

### 5. `handle_client_connection` Updates

The core logic for handling client requests has been updated to interact with the blockchain:

-   **`DaemonRequest::SignChallenge`**: The mock signature generation has been replaced with real `secp256k1` signing using the identity's `Keypair`.
-   **`DaemonRequest::Authenticate`**: This is the most significant change. The mock authentication flow has been replaced with a multi-step process that:
    1.  **Submits `NewEpisode` Transaction**: Creates and submits a `NewEpisode` transaction to the blockchain, funded by the participant's wallet.
    2.  **Waits for Episode Processing**: Polls `blockchain_episodes` until the `NewEpisode` is processed by the `kdapp` engine.
    3.  **Submits `RequestChallenge` Transaction**: Creates and submits a `RequestChallenge` transaction.
    4.  **Waits for Challenge**: Polls `blockchain_episodes` until the challenge is generated by the `kdapp` engine.
    5.  **Signs Challenge and Submits `SubmitResponse`**: Signs the received challenge and submits a `SubmitResponse` transaction.
    6.  **Waits for Authentication Success**: Polls `blockchain_episodes` until the episode is marked as authenticated and a session token is available.
    7.  **Creates Real Session**: If authentication is successful, a real `Session` is created and stored in the daemon's `sessions` HashMap.

### 6. Helper Methods

Two new asynchronous helper methods have been added to `AuthDaemon`:

-   `get_utxo_and_client`: Fetches a UTXO for a given address from the Kaspa node and returns the `KaspaRpcClient`. This ensures transactions are properly funded.
-   `submit_episode_message_transaction`: A generic method to build and submit any `EpisodeMessage` as a Kaspa transaction.

## Impact

These changes transform the `kaspa-auth` daemon from a simulated service into a true peer-to-peer authentication system that leverages the Kaspa blockchain for secure and verifiable authentication flows. All critical authentication steps are now recorded on-chain, and the daemon's internal state reflects the actual blockchain state.
